
{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<h1 class="h2 mb-4">{{ title }}</h1>
<form method="POST">
    <div class="card shadow-sm mb-4">
        <div class="card-header">Customer Information</div>
        <div class="card-body">
            <label for="customer_id" class="form-label">Select Customer</label>
            <select class="form-select" id="customer_id" name="customer_id" required>
                <option disabled selected value="">Choose...</option>
                {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">Line Items</div>
        <div class="card-body">
            <table class="table" id="line-items-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Description</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="line-items-body">
                    </tbody>
            </table>
            <button type="button" class="btn btn-outline-success" onclick="addLineItem()">+ Add Line Item</button>
        </div>
        <div class="card-footer text-end">
            <input type="hidden" name="total_amount" id="total_amount_input">
            <h3 class="mb-0">Total: $<span id="total-amount">0.00</span></h3>
        </div>
    </div>
    <div class="mt-4">
        <button type="submit" class="btn btn-primary btn-lg">Save Quote</button>
        <a href="{{ url_for('quotes.list_quotes') }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    function addLineItem() {
        const tbody = document.getElementById('line-items-body');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" name="description[]" class="form-control" placeholder="Service or Part" required></td>
            <td><input type="number" name="quantity[]" class="form-control quantity" value="1" min="1" required></td>
            <td><input type="number" name="unit_price[]" class="form-control unit-price" placeholder="0.00" step="0.01" min="0" required></td>
            <td class="line-total fw-bold align-middle">$0.00</td>
            <td class="text-center"><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); calculateTotal();">&times;</button></td>
        `;
        tbody.appendChild(newRow);
    }

    function calculateTotal() {
        let grandTotal = 0;
        document.querySelectorAll('#line-items-body tr').forEach(row => {
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
            const lineTotal = quantity * unitPrice;
            row.querySelector('.line-total').textContent = '$' + lineTotal.toFixed(2);
            grandTotal += lineTotal;
        });
        document.getElementById('total-amount').textContent = grandTotal.toFixed(2);
        document.getElementById('total_amount_input').value = grandTotal.toFixed(2);
    }

    // Add event listener to the table body for dynamic input changes
    document.getElementById('line-items-body').addEventListener('input', calculateTotal);
    
    // Add one line item to start
    addLineItem();
</script>
{% endblock %}
